# server-trucker
import { Image } from "expo-image"; import { LinearGradient } from 'expo-linear-gradient'; import * as Location from "expo-location"; import { useRouter } from "expo-router"; import React, { useEffect, useMemo, useRef, useState } from "react"; import {     ActivityIndicator,     Dimensions,     Platform,     StyleSheet,     Text,     TouchableOpacity,     View } from "react-native"; import MapView, { LatLng, Marker, PROVIDER_GOOGLE } from "react-native-maps"; import { ServiceItem } from "./ServiceList";  const { width, height } = Dimensions.get("window"); // Adjust edge padding to match the zoom level in the screenshot const EDGE_PADDING = { top: 50, right: 20, bottom: 60, left: 20 };  // Custom map style with blue hue and white water const homeMapStyle = [   {     "stylers": [       {         "hue": "#007fff"       },       {         "saturation": 89       }     ]   },   {     "featureType": "water",     "stylers": [       {         "color": "#ffffff"       }     ]   },   {     "featureType": "administrative.country",     "elementType": "labels",     "stylers": [       {         "visibility": "off"       }     ]   } ];  type Props = {   data: ServiceItem[];   onSelect: (item: ServiceItem) => void;   onSeeAll?: () => void;   onMaximize?: () => void;  // New callback for maximizing the map   height?: number;  // Keep as number only   isMaximized?: boolean;  // Add state to know if map is maximized };  export default function HomeMap({   data,   onSelect,   onSeeAll,   onMaximize,   height = 180, // Height adjusted to match the screenshot   isMaximized = false }: Props) {   const router = useRouter();   const mapRef = useRef<MapView>(null);   const userCoordRef = useRef<LatLng | null>(null);   const [isLoading, setIsLoading] = useState(true);   const [imageErrors, setImageErrors] = useState<{[key: string]: boolean}>({});   const defaultImage = require("../assets/images/icon.png");    // ----------- User Location -----------   useEffect(() => {     let mounted = true;     (async () => {       const { status } = await Location.requestForegroundPermissionsAsync();       if (status !== "granted") return setIsLoading(false);        const loc = await Location.getCurrentPositionAsync({ accuracy: Location.Accuracy.Balanced });       const coord = { latitude: loc.coords.latitude, longitude: loc.coords.longitude };       if (!mounted) return;        userCoordRef.current = coord;       setIsLoading(false);     })();          return () => {       mounted = false;     };   }, []);    // ----------- Fit map to markers -----------   useEffect(() => {     const coords = data       .filter((d) => d.latitude && d.longitude)       .map((d) => ({ latitude: d.latitude, longitude: d.longitude }));          if (coords.length && mapRef.current) {       mapRef.current.fitToCoordinates(coords, { edgePadding: EDGE_PADDING, animated: true });     }   }, [data]);    // ----------- Map Markers (first 10 only for better performance) ----------- const mapMarkers = useMemo(   () =>     data       .filter(item => item?.latitude != null && item?.longitude != null)       .slice(0, 10)       .map((item, index) => (         <Marker           key={item.id}           coordinate={{ latitude: item.latitude, longitude: item.longitude }}           onPress={() => onSelect(item)}         >           <View style={[styles.markerContainer, index % 3 === 0 && styles.markerContainerLarge]}>             <Image               source={item.icon_url ? { uri: item.icon_url } : defaultImage}               style={[styles.markerImage, index % 3 === 0 && styles.markerImageLarge]}               onError={() => setImageErrors(prev => ({ ...prev, [item.id]: true }))}             />           </View>         </Marker>       )),   [data, onSelect, imageErrors] );     if (isLoading) {     return (       <View style={[styles.container, { height }]}>         <View style={styles.loadingContainer}>           <ActivityIndicator size="small" color="#2F63FD" />         </View>       </View>     );   }    return (     <View style={[styles.container, { height }]}>       {/* Background color for the entire container */}       <View style={styles.mapBackground} />              <MapView         ref={mapRef}         provider={PROVIDER_GOOGLE}         style={styles.map}         showsUserLocation         showsTraffic={false}         showsMyLocationButton={false}         zoomEnabled={onMaximize ? true : false}         scrollEnabled={onMaximize ? true : false}         pitchEnabled={onMaximize ? true : false}         rotateEnabled={onMaximize ? true : false}         customMapStyle={homeMapStyle}         toolbarEnabled={false}         liteMode={false}         onMapReady={() => {           console.log("Map is ready with custom style");           // Re-fit to coordinates once map is ready           const coords = data             .filter((d) => d.latitude && d.longitude)             .map((d) => ({ latitude: d.latitude, longitude: d.longitude }));                      if (coords.length && mapRef.current) {             // Apply adjusted padding to match the zoom level in the screenshot             const adjustedPadding = {                ...EDGE_PADDING,                bottom: 70              };             mapRef.current.fitToCoordinates(coords, { edgePadding: adjustedPadding, animated: true });           }         }}       >         {mapMarkers}       </MapView>              {/* Maximize button - moved to top right corner */}       {onMaximize && (         <TouchableOpacity            style={styles.maximizeButton}            onPress={onMaximize}           activeOpacity={0.8}         >           <View style={styles.maximizeIconContainer}>             {!isMaximized ? (               <View style={styles.cornersOutIcon}>                 {/* CornersOut - for expanding/maximizing */}                 <View style={[styles.cornerBracket, styles.topLeft]} />                 <View style={[styles.cornerBracket, styles.topRight]} />                 <View style={[styles.cornerBracket, styles.bottomLeft]} />                 <View style={[styles.cornerBracket, styles.bottomRight]} />               </View>             ) : (               <View style={styles.cornersInIcon}>                 {/* CornersIn - for minimizing */}                 <View style={[styles.cornerBracket, styles.topLeftIn]} />                 <View style={[styles.cornerBracket, styles.topRightIn]} />                 <View style={[styles.cornerBracket, styles.bottomLeftIn]} />                 <View style={[styles.cornerBracket, styles.bottomRightIn]} />               </View>             )}           </View>         </TouchableOpacity>       )}        {/* SEE ALL button - moved to bottom right corner */}       <TouchableOpacity          style={styles.seeAllButtonBottomRight}          onPress={() => {           console.log('SEE ALL button pressed, onSeeAll:', typeof onSeeAll);           if (onSeeAll) {             onSeeAll();           } else {             // Fallback navigation if onSeeAll is not provided             router.push({               pathname: "/Work",               params: { data: JSON.stringify(data) },             });           }         }}         activeOpacity={0.7}       >         <Text style={styles.seeAllTextBottomRight}>SEE ALL</Text>       </TouchableOpacity>              {/* Top text with NEARBY DELIVERY in a map cutout */}       <View style={styles.topCutoutContainer}>         <View style={styles.topCutoutBackground}>           <Text style={styles.nearbyDeliveryText}>NEARBY PLACES</Text>         </View>       </View>              {/* Bottom dark overlay with location info */}       <LinearGradient         colors={['transparent', 'rgba(0,6,99,0.7)', 'rgba(0,6,99,1)']}         start={{ x: 0, y: 0 }}         end={{ x: 0, y: 1 }}         style={styles.bottomGradient}       >         <View style={styles.bottomContent}>           <View style={styles.textContainer}>             <Text style={styles.locationText}>Truck Stops in Tennessee (TN), 37640</Text>             <Text style={styles.placesText}>{data.length} places found</Text>           </View>         </View>       </LinearGradient>     </View>   ); }  const styles = StyleSheet.create({   container: {     width: '100%',     overflow: 'hidden',     borderRadius: 12, // Slightly smaller border radius to match the      ...Platform.select({       ios: {         shadowColor: '#000',         shadowOffset: { width: 0, height: 1 },         shadowOpacity: 0.1,         shadowRadius: 2,       },       android: {         elevation: 3,       },     }),   },   mapBackground: {     ...StyleSheet.absoluteFillObject,     backgroundColor: '#FFFFFF',   },   map: {      ...StyleSheet.absoluteFillObject,     borderTopLeftRadius: 0, // Remove top-left radius to accommodate the cutout     top: 24, // Adjusted to match the     bottom: 0, // Ensure map extends to the bottom     left: 0,     right: 0,   },   empty: {      flex: 1,      justifyContent: "center",      alignItems: "center"    },   loadingContainer: {     flex: 1,     justifyContent: 'center',     alignItems: 'center',     backgroundColor: '#f0f4f8',   },   markerContainer: {     width: 24,     height: 24,     borderRadius: 12,     backgroundColor: "#FFFFFF",     borderWidth: 1.5,     borderColor: "#FFFFFF",     shadowColor: "#000",     shadowOffset: {width: 0, height: 1},     shadowOpacity: 0.3,     shadowRadius: 2,     elevation: 2,     justifyContent: 'center',     alignItems: 'center',     overflow: 'hidden',   },   markerContainerLarge: {     width: 32,     height: 32,     borderRadius: 16,     borderWidth: 2,   },   markerImage: {     width: '100%',     height: '100%',     borderRadius: 12,   },   markerImageLarge: {     borderRadius: 16,   },   // Keeping old styles for backward compatibility   markerDot: {     width: 8,     height: 8,     borderRadius: 4,     backgroundColor: "#266BF9",     borderWidth: 1.5,     borderColor: "#FFFFFF",     shadowColor: "#000",     shadowOffset: {width: 0, height: 1},     shadowOpacity: 0.3,     shadowRadius: 2,     elevation: 2,   },   markerDotLarge: {     width: 10,     height: 10,     borderRadius: 5,     backgroundColor: "#0042C5",     borderWidth: 2,     borderColor: "#FFFFFF",   },   // Container for the map cutout with text   topCutoutContainer: {     position: 'absolute',     top: 9,     left: 0,     zIndex: 55,     paddingTop: 6,   },   // Background for the cutout effect   topCutoutBackground: {     backgroundColor: '#FFFFFF',     paddingHorizontal: 40,     paddingVertical: 15,     paddingBottom: 8,     borderBottomRightRadius: 100   },   bottomGradient: {     position: 'absolute',     left: 0,     right: 0,     bottom: 0,     height: 70, // Reduced height to match the screenshot     zIndex: 15, // Higher than the ServiceList zIndex (10) to ensure button is always clickable     justifyContent: 'flex-end',     paddingBottom: 12,   },   // Text styles for the nearby delivery header - matching screenshot   nearbyDeliveryText: {     color: '#1E3A5F',     fontSize: 12, // Smaller font size to match the screenshot     fontWeight: '700',     letterSpacing: 0.5,   },   bottomContent: {     flexDirection: 'row',     justifyContent: 'space-between',     alignItems: 'center',     paddingHorizontal: 12, // Reduced to match the screenshot     paddingBottom: 6, // Added to match the screenshot     zIndex: 16, // Ensure content is above other elements     position: 'relative',   },   textContainer: {     flex: 1,   },   locationText: {     color: '#FFFFFF',     fontSize: 12,      fontWeight: '600',     marginBottom: 2,     lineHeight: 16,   },   placesText: {     color: '#FFFFFF',     fontSize: 10,      opacity: 0.8,   },   expandButton: {     width: 24,      height: 24,     borderRadius: 12,     backgroundColor: 'rgba(255, 255, 255, 0.2)', // Lighter to match the screenshot     justifyContent: 'center',     alignItems: 'center',     marginLeft: 8, // Smaller margin to match the screenshot     shadowColor: '#000',     shadowOffset: {width: 0, height: 1},     shadowOpacity: 0.15,     shadowRadius: 1,     elevation: 2,   },   expandIcon: {     color: '#FFFFFF',     fontSize: 14,      fontWeight: '600',     transform: [{ rotate: '45deg' }],   },   // Previous controls - now removed in favor of the bottom gradient content   controlsContainer: {     position: 'absolute',     bottom: 10,     right: 10,     zIndex: 3,   },   seeAllButton: {     backgroundColor: 'rgba(255, 255, 255, 0.95)',     paddingHorizontal: 14,     paddingVertical: 8,     borderRadius: 16,     marginLeft: 8,     minWidth: 70,     alignItems: 'center',     justifyContent: 'center',     zIndex: 20, // Ensure button is always on top     ...Platform.select({       ios: {         shadowColor: '#000',         shadowOffset: { width: 0, height: 2 },         shadowOpacity: 0.25,         shadowRadius: 3,       },       android: {         elevation: 8, // Higher elevation for Android       },     }),   },   seeAllText: {     color: '#2F63FD',     fontWeight: '800',     fontSize: 12,     letterSpacing: 0.8,     textAlign: 'center',   },   // Maximize button styles - moved to top right corner with modern design   maximizeButton: {     position: 'absolute',     top: 35,     right: 10,     width: 40,     height: 40,     borderRadius: 20,     backgroundColor: 'rgba(255, 255, 255, 0.95)',     justifyContent: 'center',     alignItems: 'center',     zIndex: 10,     borderWidth: 1,     borderColor: 'rgba(47, 99, 253, 0.1)',     ...Platform.select({       ios: {         shadowColor: '#2F63FD',         shadowOffset: { width: 0, height: 4 },         shadowOpacity: 0.15,         shadowRadius: 8,       },       android: {         elevation: 6,       },     }),   },   maximizeIconContainer: {     width: 24,     height: 24,     borderRadius: 12,     backgroundColor: 'rgba(47, 99, 253, 0.1)',     justifyContent: 'center',     alignItems: 'center',   },   maximizeIcon: {     fontSize: 14,     color: '#2F63FD',     fontWeight: '600',   },   // Custom corners out icon styles   cornersOutIcon: {     width: 16,     height: 16,     position: 'relative',   },   cornerBracket: {     position: 'absolute',     borderColor: '#2F63FD',     borderWidth: 1.5,   },   // Corner positions for "expand out" icon   topLeft: {     top: 0,     left: 0,     width: 5,     height: 5,     borderRightWidth: 0,     borderBottomWidth: 0,   },   topRight: {     top: 0,     right: 0,     width: 5,     height: 5,     borderLeftWidth: 0,     borderBottomWidth: 0,   },   bottomLeft: {     bottom: 0,     left: 0,     width: 5,     height: 5,     borderRightWidth: 0,     borderTopWidth: 0,   },   bottomRight: {     bottom: 0,     right: 0,     width: 5,     height: 5,     borderLeftWidth: 0,     borderTopWidth: 0,   },   // Custom corners in icon styles   cornersInIcon: {     width: 16,     height: 16,     position: 'relative',   },   // Corner positions for "minimize in" icon - positioned more inward   topLeftIn: {     top: 3,     left: 3,     width: 4,     height: 4,     borderRightWidth: 0,     borderBottomWidth: 0,   },   topRightIn: {     top: 3,     right: 3,     width: 4,     height: 4,     borderLeftWidth: 0,     borderBottomWidth: 0,   },   bottomLeftIn: {     bottom: 3,     left: 3,     width: 4,     height: 4,     borderRightWidth: 0,     borderTopWidth: 0,   },   bottomRightIn: {     bottom: 3,     right: 3,     width: 4,     height: 4,     borderLeftWidth: 0,     borderTopWidth: 0,   },   // SEE ALL button styles - moved to bottom right corner   seeAllButtonBottomRight: {     position: 'absolute',     bottom: 80,     right: 10,     backgroundColor: 'rgba(255, 255, 255, 0.95)',     paddingHorizontal: 12,     paddingVertical: 8,     borderRadius: 16,     minWidth: 70,     alignItems: 'center',     justifyContent: 'center',     zIndex: 20, // Ensure button is always on top     ...Platform.select({       ios: {         shadowColor: '#000',         shadowOffset: { width: 0, height: 2 },         shadowOpacity: 0.25,         shadowRadius: 3,       },       android: {         elevation: 8, // Higher elevation for Android       },     }),   },   seeAllTextBottomRight: {     color: '#2F63FD',     fontWeight: '800',     fontSize: 11,     letterSpacing: 0.8,     textAlign: 'center',   }, });